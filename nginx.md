# Install
```bash
sudo apt-get install nginx
````

# Add first sites config
```nginx
server {
        listen 80 default_server;
        listen [::]:80 default_server;

        # SSL configuration
        #
        # listen 443 ssl default_server;
        # listen [::]:443 ssl default_server;
        #
        # Note: You should disable gzip for SSL traffic.
        # See: https://bugs.debian.org/773332
        #
        # Read up on ssl_ciphers to ensure a secure configuration.
        # See: https://bugs.debian.org/765782
        #
        # Self signed certs generated by the ssl-cert package
        # Don't use them in a production server!
        #
        # include snippets/snakeoil.conf;

        root /home/sites/example.com;

        index index.php index.html index.htm index.nginx-debian.html;

        server_name example.com;

        location / {
                try_files $uri $uri/ =404;
        }

        location ~ \.php$ {
                include snippets/fastcgi-php.conf;

                fastcgi_split_path_info ^(.+\.php)(/.+)$;
                fastcgi_pass unix:/run/php/php8.1-fpm.sock;
                # fastcgi_index index.php;
                include fastcgi.conf;
                fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
                fastcgi_param PATH_INFO $fastcgi_script_name;
                fastcgi_param DOCUMENT_ROOT $document_root;
        }

}
```
SSL mode generated later with certbot

# Tuning

Backup your original configs and you can start reconfigure your configs. You will need to open your nginx.conf at /etc/nginx/nginx.conf with your favorite editor.

Тюнинг конфига для небольших серверов (CPU 2-8, RAM 2-16) с целью максимальной (или близко к тому) производительности.


```nginx
# you must set worker processes based on your CPU cores, nginx does not benefit from setting more than that
#some last versions calculate it automatically
worker_processes auto; 

# number of file descriptors used for nginx
# the limit for the maximum FDs on the server is usually set by the OS.
# if you don't set FD's then OS settings will be used which is by default 2000
worker_rlimit_nofile 10000;

# only log critical errors
error_log /var/log/nginx/error.log crit;

# provides the configuration file context in which the directives that affect connection processing are specified.
events {
    # determines how much clients will be served per worker
    # max clients = worker_connections * worker_processes
    # max clients is also limited by the number of socket connections available on the system (~64k)
    worker_connections 4000;

    # optimized to serve many clients with each thread, essential for linux -- for testing environment
    use epoll;

    # accept as many connections as possible, may flood worker connections if set too low -- for testing environment
    multi_accept on;
}

http {
    # cache informations about FDs, frequently accessed files
    # can boost performance, but you need to test those values
    # open_file_cache max=200000 inactive=20s;
    # open_file_cache_valid 30s;
    # open_file_cache_min_uses 2;
    # open_file_cache_errors on;

    # to boost I/O on HDD we can disable access logs
    # access_log off;



    # copies data between one FD and other from within the kernel
    # faster than read() + write()
    sendfile on;
    
    # it makes no sense for third-party users to know the version of nginx
    server_tokens off;

    # send headers in one piece, it is better than sending them one by one
    tcp_nopush on;

    # don't buffer data sent, good for small data bursts in real time
    tcp_nodelay on;



    # if the request body size is more than the buffer size, then the entire (or partial)
    # request body is written into a temporary file
    # the performance impact of this is probably not that great, unless you are severely memory constrained and getting 
    # lots of uploads at the same time.
    client_body_buffer_size  128k;

    # buffer size for reading client request header -- for testing environment
    client_header_buffer_size 2k;

    # maximum number and size of buffers for large headers to read from client request
    large_client_header_buffers 4 2k;
    
    

    # allow the server to close connection on non responding client, this will free up memory
    reset_timedout_connection on;
    
    # read timeout for the request body from client
    client_body_timeout   10s;

    # how long to wait for the client to send a request header
    client_header_timeout 10s;

    # if client stop responding, free up memory -- default 60
    send_timeout 10s;

    # server will close connection after this time -- default 75
    keepalive_timeout 15s;

    # number of requests client can make over keep-alive
    # closing connections periodically is necessary to free per-connection memory allocations. 
    # therefore, using too high maximum number of requests could result in excessive memory usage and not recommended.
    keepalive_requests 10000;
    


    # reduce the data that needs to be sent over network -- for testing environment
    gzip on;
    # gzip_static on;
    gzip_min_length 10240;
    gzip_comp_level 1;
    gzip_vary on;
    gzip_disable msie6;
    gzip_proxied expired no-cache no-store private auth;
    gzip_types
        # text/html is always compressed by HttpGzipModule
        text/css
        text/javascript
        text/xml
        text/plain
        text/x-component
        application/javascript
        application/x-javascript
        application/json
        application/xml
        application/rss+xml
        application/atom+xml
        font/truetype
        font/opentype
        application/vnd.ms-fontobject
        image/svg+xml;
}
```

# Check config
``` bash
# check config
/etc/init.d/nginx configtest
# reload for a soft restart without disconnecting clients OR restart for a hard restart
/etc/init.d/nginx reload|restart
```


# Links
- https://gist.github.com/denji/8359866 
- https://www.nginx.com/resources/wiki/start/topics/examples/fullexample2/
- https://www.digitalocean.com/community/tutorials/how-to-optimize-nginx-configuration


